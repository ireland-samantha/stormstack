<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LightningFirefly - Game Simulation Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #252542;
            --accent: #00d4ff;
            --accent-dim: #0099cc;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4444;
            --text-primary: #ffffff;
            --text-secondary: #aaaacc;
            --border: #333355;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 50px 1fr 40px;
            height: 100vh;
            gap: 1px;
            background: var(--border);
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header h1::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .header-stats span {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .header-stats .value {
            color: var(--accent);
            font-weight: 600;
        }

        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            overflow-y: auto;
            padding: 15px;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-section h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-section h3 .count {
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
        }

        .item-list {
            list-style: none;
        }

        .item-list li {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 10px 12px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .item-list li:hover {
            border-color: var(--accent-dim);
        }

        .item-list li.selected {
            border-color: var(--accent);
            background: rgba(0, 212, 255, 0.1);
        }

        .item-list .item-title {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .item-list .item-meta {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .item-list .item-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 6px;
        }

        .badge {
            font-size: 9px;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-secondary);
        }

        .badge.module { background: rgba(0, 212, 255, 0.2); color: var(--accent); }
        .badge.player { background: rgba(0, 255, 136, 0.2); color: var(--success); }
        .badge.entity { background: rgba(255, 170, 0, 0.2); color: var(--warning); }

        /* Main Canvas Area */
        .main-view {
            background: var(--bg-primary);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .canvas-header {
            background: var(--bg-secondary);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .canvas-header h2 {
            font-size: 14px;
            font-weight: 500;
        }

        .canvas-controls {
            display: flex;
            gap: 10px;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #gameCanvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .canvas-overlay {
            position: absolute;
            bottom: 15px;
            left: 15px;
            background: rgba(26, 26, 46, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 11px;
            border: 1px solid var(--border);
        }

        .canvas-overlay .legend {
            display: flex;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        /* Right Panel */
        .right-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-tabs {
            display: flex;
            background: var(--bg-primary);
        }

        .panel-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .panel-tab:hover {
            background: var(--bg-tertiary);
        }

        .panel-tab.active {
            border-bottom-color: var(--accent);
            color: var(--accent);
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .panel-section {
            display: none;
        }

        .panel-section.active {
            display: block;
        }

        /* Forms */
        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 13px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .btn-primary:hover {
            background: var(--accent-dim);
        }

        .btn-success {
            background: var(--success);
            color: var(--bg-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-group {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Entity Inspector */
        .entity-inspector {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .entity-inspector h4 {
            font-size: 13px;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .component-list {
            font-size: 11px;
        }

        .component-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--border);
        }

        .component-item:last-child {
            border-bottom: none;
        }

        .component-name {
            color: var(--text-secondary);
        }

        .component-value {
            color: var(--success);
            font-family: monospace;
        }

        /* Status Bar */
        .status-bar {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            display: flex;
            align-items: center;
            padding: 0 15px;
            font-size: 11px;
            color: var(--text-secondary);
            gap: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .status-dot.connected { background: var(--success); }
        .status-dot.disconnected { background: var(--danger); }

        /* Log Panel */
        .log-panel {
            background: var(--bg-primary);
            border-radius: 6px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
        }

        .log-entry {
            padding: 3px 0;
            border-bottom: 1px solid var(--border);
        }

        .log-entry.info { color: var(--text-secondary); }
        .log-entry.success { color: var(--success); }
        .log-entry.error { color: var(--danger); }
        .log-entry.warning { color: var(--warning); }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dim);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .empty-state .icon {
            font-size: 32px;
            margin-bottom: 10px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <h1>LightningFirefly Simulation</h1>
            <div class="header-stats">
                <span>Tick: <span class="value" id="currentTick">0</span></span>
                // todo for AI: please have each entity separate and allow me to expand
                // to see all components,
                <span>Entities: <span class="value" id="entityCount">0</span></span>
                <span>FPS: <span class="value" id="fps">0</span></span>
            </div>
        </header>

        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-section">
                <h3>Matches <span class="count" id="matchCount">0</span></h3>
                <ul class="item-list" id="matchList">
                    <li class="empty-state">
                        <div class="icon">&#x1F3AE;</div>
                        <div>No matches yet</div>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Players <span class="count" id="playerCount">0</span></h3>
                <ul class="item-list" id="playerList">
                    <li class="empty-state">
                        <div class="icon">&#x1F464;</div>
                        <div>No players yet</div>
                    </li>
                </ul>
            </div>

            <div class="sidebar-section">
                <h3>Modules <span class="count" id="moduleCount">0</span></h3>
                <ul class="item-list" id="moduleList">
                    <li class="empty-state">
                        <div class="icon">&#x1F4E6;</div>
                        <div>No modules loaded</div>
                    </li>
                </ul>
            </div>
        </aside>

        <!-- Main Canvas View -->
        <main class="main-view">
            <div class="canvas-header">
                <h2>Match View: <span id="selectedMatchName">None selected</span></h2>
                <div class="canvas-controls">
                    <button class="btn btn-secondary" onclick="resetView()">Reset View</button>
                    <button class="btn btn-primary" onclick="advanceTick()">Advance Tick</button>
                </div>
            </div>
            <div class="canvas-container">
                <canvas id="gameCanvas"></canvas>
                <div class="canvas-overlay">
                    <div class="legend">
                        <div class="legend-item">
                            <div class="legend-color" style="background: #00ff88;"></div>
                            <span>Player Entity</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #00d4ff;"></div>
                            <span>Unit</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-color" style="background: #ffaa00;"></div>
                            <span>Resource</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Right Panel -->
        <aside class="right-panel">
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="switchTab('actions')">Actions</div>
                <div class="panel-tab" onclick="switchTab('entities')">Entities</div>
                <div class="panel-tab" onclick="switchTab('logs')">Logs</div>
            </div>

            <div class="panel-content">
                <!-- Actions Tab -->
                <div id="tab-actions" class="panel-section active">
                    <div class="form-group">
                        <label>Quick Actions</label>
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="createMatch()">+ Match</button>
                            <button class="btn btn-success" onclick="createPlayer()">+ Player</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Match ID</label>
                        <input type="number" id="matchIdInput" placeholder="Enter match ID" value="1">
                    </div>

                    <div class="form-group">
                        <label>Player ID</label>
                        <input type="number" id="playerIdInput" placeholder="Enter player ID" value="1">
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="joinMatch()">Join Match</button>
                        <button class="btn btn-danger" onclick="leaveMatch()">Leave</button>
                    </div>

                    <hr style="border-color: var(--border); margin: 15px 0;">

                    <div class="form-group">
                        <label>Send Command</label>
                        <select id="commandSelect">
                            <option value="spawn">Spawn Unit</option>
                            <option value="move">Move Unit</option>
                        </select>
                    </div>

                    <div id="spawnFields">
                        <div class="form-group">
                            <label>Entity Type</label>
                            <input type="text" id="entityType" placeholder="unit" value="unit">
                        </div>
                        <div class="form-group">
                            <label>Position X</label>
                            <input type="number" id="spawnX" placeholder="X" value="100">
                        </div>
                        <div class="form-group">
                            <label>Position Y</label>
                            <input type="number" id="spawnY" placeholder="Y" value="100">
                        </div>
                    </div>

                    <div id="moveFields" style="display:none;">
                        <div class="form-group">
                            <label>Entity ID</label>
                            <input type="number" id="moveEntityId" placeholder="Entity ID">
                        </div>
                        <div class="form-group">
                            <label>Target X</label>
                            <input type="number" id="moveX" placeholder="X">
                        </div>
                        <div class="form-group">
                            <label>Target Y</label>
                            <input type="number" id="moveY" placeholder="Y">
                        </div>
                    </div>

                    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="sendCommand()">Send Command</button>

                    <hr style="border-color: var(--border); margin: 15px 0;">

                    <div class="form-group">
                        <label>Simulation Control</label>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="reloadModules()">Reload Modules</button>
                        </div>
                    </div>
                </div>

                <!-- Entities Tab -->
                <div id="tab-entities" class="panel-section">
                    <div id="entityInspector">
                        <div class="empty-state">
                            <div class="icon">&#x1F50D;</div>
                            <div>Select a match to view entities</div>
                        </div>
                    </div>
                </div>

                <!-- Logs Tab -->
                <div id="tab-logs" class="panel-section">
                    <div class="log-panel" id="logPanel">
                        <div class="log-entry info">[System] Panel initialized</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Status Bar -->
        <footer class="status-bar">
            <div class="status-item">
                <div class="status-dot" id="wsStatus"></div>
                <span id="wsStatusText">Connecting...</span>
            </div>
            <div class="status-item">
                <span>API: <span id="apiStatus">Ready</span></span>
            </div>
            <div class="status-item" style="margin-left: auto;">
                <span>WebGL: <span id="webglStatus">Initializing...</span></span>
            </div>
        </footer>
    </div>

    <script>
        // ============================================
        // State Management
        // ============================================
        const state = {
            matches: [],
            players: [],
            modules: [],
            selectedMatchId: null,
            snapshot: null,
            entities: {},
            tick: 0,
            wsConnected: false
        };

        // ============================================
        // WebGL Renderer
        // ============================================
        class WebGLRenderer {
            constructor(canvas) {
                this.canvas = canvas;
                this.gl = canvas.getContext('webgl2') || canvas.getContext('webgl');

                if (!this.gl) {
                    console.error('WebGL not supported');
                    document.getElementById('webglStatus').textContent = 'Not supported';
                    return;
                }

                document.getElementById('webglStatus').textContent = 'Ready';

                this.entities = [];
                this.camera = { x: 0, y: 0, zoom: 1 };
                this.gridSize = 50;

                this.initShaders();
                this.initBuffers();
                this.resize();

                window.addEventListener('resize', () => this.resize());
                this.setupMouseControls();

                this.lastTime = 0;
                this.frameCount = 0;
                this.fpsTime = 0;
            }

            initShaders() {
                const vsSource = `
                    attribute vec2 aPosition;
                    attribute vec4 aColor;
                    uniform vec2 uResolution;
                    uniform vec2 uCamera;
                    uniform float uZoom;
                    varying vec4 vColor;

                    void main() {
                        vec2 pos = (aPosition - uCamera) * uZoom;
                        vec2 clipSpace = (pos / uResolution) * 2.0 - 1.0;
                        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
                        gl_PointSize = 20.0 * uZoom;
                        vColor = aColor;
                    }
                `;

                const fsSource = `
                    precision mediump float;
                    varying vec4 vColor;

                    void main() {
                        vec2 coord = gl_PointCoord - vec2(0.5);
                        float dist = length(coord);
                        if (dist > 0.5) discard;
                        float alpha = 1.0 - smoothstep(0.3, 0.5, dist);
                        gl_FragColor = vec4(vColor.rgb, vColor.a * alpha);
                    }
                `;

                const gridVsSource = `
                    attribute vec2 aPosition;
                    uniform vec2 uResolution;
                    uniform vec2 uCamera;
                    uniform float uZoom;

                    void main() {
                        vec2 pos = (aPosition - uCamera) * uZoom;
                        vec2 clipSpace = (pos / uResolution) * 2.0 - 1.0;
                        gl_Position = vec4(clipSpace * vec2(1, -1), 0, 1);
                    }
                `;

                const gridFsSource = `
                    precision mediump float;
                    uniform vec4 uColor;

                    void main() {
                        gl_FragColor = uColor;
                    }
                `;

                this.program = this.createProgram(vsSource, fsSource);
                this.gridProgram = this.createProgram(gridVsSource, gridFsSource);

                // Get locations
                this.aPosition = this.gl.getAttribLocation(this.program, 'aPosition');
                this.aColor = this.gl.getAttribLocation(this.program, 'aColor');
                this.uResolution = this.gl.getUniformLocation(this.program, 'uResolution');
                this.uCamera = this.gl.getUniformLocation(this.program, 'uCamera');
                this.uZoom = this.gl.getUniformLocation(this.program, 'uZoom');

                this.gridAPosition = this.gl.getAttribLocation(this.gridProgram, 'aPosition');
                this.gridUResolution = this.gl.getUniformLocation(this.gridProgram, 'uResolution');
                this.gridUCamera = this.gl.getUniformLocation(this.gridProgram, 'uCamera');
                this.gridUZoom = this.gl.getUniformLocation(this.gridProgram, 'uZoom');
                this.gridUColor = this.gl.getUniformLocation(this.gridProgram, 'uColor');
            }

            createProgram(vsSource, fsSource) {
                const gl = this.gl;

                const vs = gl.createShader(gl.VERTEX_SHADER);
                gl.shaderSource(vs, vsSource);
                gl.compileShader(vs);

                const fs = gl.createShader(gl.FRAGMENT_SHADER);
                gl.shaderSource(fs, fsSource);
                gl.compileShader(fs);

                const program = gl.createProgram();
                gl.attachShader(program, vs);
                gl.attachShader(program, fs);
                gl.linkProgram(program);

                return program;
            }

            initBuffers() {
                this.positionBuffer = this.gl.createBuffer();
                this.colorBuffer = this.gl.createBuffer();
                this.gridBuffer = this.gl.createBuffer();
            }

            resize() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
                this.gl.viewport(0, 0, this.canvas.width, this.canvas.height);
            }

            setupMouseControls() {
                let isDragging = false;
                let lastX, lastY;

                this.canvas.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    lastX = e.clientX;
                    lastY = e.clientY;
                });

                this.canvas.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        const dx = e.clientX - lastX;
                        const dy = e.clientY - lastY;
                        this.camera.x -= dx / this.camera.zoom;
                        this.camera.y -= dy / this.camera.zoom;
                        lastX = e.clientX;
                        lastY = e.clientY;
                    }
                });

                this.canvas.addEventListener('mouseup', () => isDragging = false);
                this.canvas.addEventListener('mouseleave', () => isDragging = false);

                this.canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const factor = e.deltaY > 0 ? 0.9 : 1.1;
                    this.camera.zoom = Math.max(0.1, Math.min(5, this.camera.zoom * factor));
                });
            }

            setEntities(entities) {
                this.entities = entities;
            }

            render(timestamp) {
                // FPS calculation
                this.frameCount++;
                if (timestamp - this.fpsTime >= 1000) {
                    document.getElementById('fps').textContent = this.frameCount;
                    this.frameCount = 0;
                    this.fpsTime = timestamp;
                }

                const gl = this.gl;

                gl.clearColor(0.06, 0.06, 0.10, 1.0);
                gl.clear(gl.COLOR_BUFFER_BIT);
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

                // Draw grid
                this.drawGrid();

                // Draw entities
                if (this.entities.length > 0) {
                    this.drawEntities();
                }

                requestAnimationFrame((t) => this.render(t));
            }

            drawGrid() {
                const gl = this.gl;
                const lines = [];
                const size = 2000;
                const step = this.gridSize;

                for (let x = -size; x <= size; x += step) {
                    lines.push(x, -size, x, size);
                }
                for (let y = -size; y <= size; y += step) {
                    lines.push(-size, y, size, y);
                }

                gl.useProgram(this.gridProgram);
                gl.bindBuffer(gl.ARRAY_BUFFER, this.gridBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(lines), gl.STATIC_DRAW);

                gl.enableVertexAttribArray(this.gridAPosition);
                gl.vertexAttribPointer(this.gridAPosition, 2, gl.FLOAT, false, 0, 0);

                gl.uniform2f(this.gridUResolution, this.canvas.width, this.canvas.height);
                gl.uniform2f(this.gridUCamera, this.camera.x, this.camera.y);
                gl.uniform1f(this.gridUZoom, this.camera.zoom);
                gl.uniform4f(this.gridUColor, 0.15, 0.15, 0.25, 0.5);

                gl.drawArrays(gl.LINES, 0, lines.length / 2);
            }

            drawEntities() {
                const gl = this.gl;
                const positions = [];
                const colors = [];

                this.entities.forEach(entity => {
                    // todo ai - please just draw the positions
                    positions.push(entity.x, entity.y);
                    colors.push(entity.r, entity.g, entity.b, entity.a);
                });

                gl.useProgram(this.program);

                gl.bindBuffer(gl.ARRAY_BUFFER, this.positionBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.DYNAMIC_DRAW);
                gl.enableVertexAttribArray(this.aPosition);
                gl.vertexAttribPointer(this.aPosition, 2, gl.FLOAT, false, 0, 0);

                gl.bindBuffer(gl.ARRAY_BUFFER, this.colorBuffer);
                gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.DYNAMIC_DRAW);
                gl.enableVertexAttribArray(this.aColor);
                gl.vertexAttribPointer(this.aColor, 4, gl.FLOAT, false, 0, 0);

                gl.uniform2f(this.uResolution, this.canvas.width, this.canvas.height);
                gl.uniform2f(this.uCamera, this.camera.x, this.camera.y);
                gl.uniform1f(this.uZoom, this.camera.zoom);

                gl.drawArrays(gl.POINTS, 0, this.entities.length);
            }

            resetView() {
                this.camera = { x: 0, y: 0, zoom: 1 };
            }
        }

        // ============================================
        // API Functions
        // ============================================
        const API_BASE = window.location.origin;
        const WS_BASE = `ws://${window.location.host}`;

        async function apiCall(method, path, body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) options.body = JSON.stringify(body);

                const response = await fetch(`${API_BASE}${path}`, options);
                if (!response.ok && response.status !== 204) {
                    throw new Error(`HTTP ${response.status}`);
                }

                if (response.status === 204) return null;
                return await response.json();
            } catch (error) {
                log(`API Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Matches
        async function fetchMatches() {
            state.matches = await apiCall('GET', '/api/matches');
            updateMatchList();
            document.getElementById('matchCount').textContent = state.matches.length;
        }

        async function createMatch() {
            const id = parseInt(document.getElementById('matchIdInput').value) || Date.now();
            // todo ai: make the modules customizable as a dropdown of installed modules
            await apiCall('POST', '/api/matches', { id: id, enabledModuleNames: ['MoveModule', 'SpawnModule' ] });
            log(`Created match ${id}`, 'success');
            fetchMatches();
        }

        async function deleteMatch(id) {
            await apiCall('DELETE', `/api/matches/${id}`);
            log(`Deleted match ${id}`, 'success');
            if (state.selectedMatchId === id) {
                state.selectedMatchId = null;
                disconnectSnapshotWs();
            }
            fetchMatches();
        }

        // Players
        async function fetchPlayers() {
            state.players = await apiCall('GET', '/api/players');
            updatePlayerList();
            document.getElementById('playerCount').textContent = state.players.length;
        }

        async function createPlayer() {
            const id = parseInt(document.getElementById('playerIdInput').value) || Date.now();
            await apiCall('POST', '/api/players', { id });
            log(`Created player ${id}`, 'success');
            fetchPlayers();
        }

        async function deletePlayer(id) {
            await apiCall('DELETE', `/api/players/${id}`);
            log(`Deleted player ${id}`, 'success');
            fetchPlayers();
        }

        // Player-Match
        async function joinMatch() {
            const playerId = parseInt(document.getElementById('playerIdInput').value);
            const matchId = parseInt(document.getElementById('matchIdInput').value);
            await apiCall('POST', '/api/player-matches', { playerId, matchId });
            log(`Player ${playerId} joined match ${matchId}`, 'success');
            fetchMatches();
        }

        async function leaveMatch() {
            const playerId = parseInt(document.getElementById('playerIdInput').value);
            const matchId = parseInt(document.getElementById('matchIdInput').value);
            await apiCall('DELETE', `/api/player-matches/player/${playerId}/match/${matchId}`);
            log(`Player ${playerId} left match ${matchId}`, 'success');
            fetchMatches();
        }

        // Modules
        async function fetchModules() {
            state.modules = await apiCall('GET', '/api/modules');
            updateModuleList();
            document.getElementById('moduleCount').textContent = state.modules.length;
        }

        async function reloadModules() {
            await apiCall('POST', '/api/modules/reload');
            log('Modules reloaded', 'success');
            fetchModules();
        }

        // Simulation
        async function fetchTick() {
            const data = await apiCall('GET', '/api/simulation/tick');
            state.tick = data.tick;
            document.getElementById('currentTick').textContent = state.tick;
        }

        async function advanceTick() {
            const data = await apiCall('POST', '/api/simulation/tick');
            state.tick = data.tick;
            document.getElementById('currentTick').textContent = state.tick;
            log(`Advanced to tick ${state.tick}`, 'info');
        }

        // Commands
        async function sendCommand() {
            const commandType = document.getElementById('commandSelect').value;
            const matchId = parseInt(document.getElementById('matchIdInput').value);
            const playerId = parseInt(document.getElementById('playerIdInput').value);

            let commandName, payload;

            if (commandType === 'spawn') {
                commandName = 'spawn';
                payload = {
                    matchId,
                    playerId,
                    entityType: document.getElementById('entityType').value,
                    positionX: parseInt(document.getElementById('spawnX').value),
                    positionY: parseInt(document.getElementById('spawnY').value)
                };
            } else if (commandType === 'move') {
                commandName = 'move';
                payload = {
                    matchId,
                    playerId,
                    entityId: parseInt(document.getElementById('moveEntityId').value),
                    targetX: parseInt(document.getElementById('moveX').value),
                    targetY: parseInt(document.getElementById('moveY').value)
                };
            }

            await apiCall('POST', '/api/engineCommands', { commandName, payload });
            log(`Sent ${commandName} engineCommand`, 'success');
        }

        // Snapshot
        async function fetchSnapshot(matchId) {
            const data = await apiCall('GET', `/api/snapshots/match/${matchId}`);
            processSnapshot(data);
        }

        // ============================================
        // WebSocket
        // ============================================
        let snapshotWs = null;
        let commandWs = null;

        function connectCommandWs() {
            commandWs = new WebSocket(`${WS_BASE}/ws/engineCommands`);

            commandWs.onopen = () => {
                updateWsStatus(true);
                log('Command WebSocket connected', 'success');
            };

            commandWs.onclose = () => {
                updateWsStatus(false);
                log('Command WebSocket disconnected', 'warning');
                setTimeout(connectCommandWs, 3000);
            };

            commandWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log(`WS: ${data.status} - ${data.message || data.engineCommand || ''}`, 'info');
            };

            commandWs.onerror = () => {
                log('Command WebSocket error', 'error');
            };
        }

        function connectSnapshotWs(matchId) {
            disconnectSnapshotWs();

            snapshotWs = new WebSocket(`${WS_BASE}/ws/snapshots/${matchId}`);

            snapshotWs.onopen = () => {
                log(`Snapshot stream connected for match ${matchId}`, 'success');
            };

            snapshotWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                processSnapshot(data);
            };

            snapshotWs.onclose = () => {
                log('Snapshot stream disconnected', 'warning');
            };
        }

        function disconnectSnapshotWs() {
            if (snapshotWs) {
                snapshotWs.close();
                snapshotWs = null;
            }
        }

        function updateWsStatus(connected) {
            state.wsConnected = connected;
            const dot = document.getElementById('wsStatus');
            const text = document.getElementById('wsStatusText');
            dot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
            text.textContent = connected ? 'Connected' : 'Disconnected';
        }

        // ============================================
        // Snapshot Processing
        // ============================================
        function processSnapshot(data) {
            state.snapshot = data;
            state.tick = data.tick;
            document.getElementById('currentTick').textContent = state.tick;

            // Parse entities from snapshot data
            const entities = [];
            let entityCount = 0;

            if (data.data) {
                // data structure: { componentName: { entityId: [values] } }
                const positionData = {};

                Object.entries(data.data).forEach(([componentName, entityMap]) => {
                    Object.entries(entityMap).forEach(([entityId, values]) => {
                        if (!positionData[entityId]) {
                            positionData[entityId] = { id: entityId, components: {} };
                        }
                        positionData[entityId].components[componentName] = values;
                    });
                });

                Object.values(positionData).forEach(entity => {
                    entityCount++;
                    const x = entity.components['POSITION_X']?.[0] ||
                              entity.components['positionX']?.[0] ||
                              Math.random() * 500;
                    const y = entity.components['POSITION_Y']?.[0] ||
                              entity.components['positionY']?.[0] ||
                              Math.random() * 500;

                    // Color based on entity type
                    let r = 0, g = 0.83, b = 1, a = 1; // Default cyan

                    if (entity.components['PLAYER_ID'] || entity.components['playerId']) {
                        r = 0; g = 1; b = 0.53; // Green for player entities
                    }
                    if (entity.components['HEALTH'] || entity.components['health']) {
                        r = 1; g = 0.67; b = 0; // Orange for units with health
                    }

                    entities.push({ x, y, r, g, b, a, ...entity });
                });
            }

            document.getElementById('entityCount').textContent = entityCount;

            if (renderer) {
                renderer.setEntities(entities);
            }

            state.entities = entities;
            updateEntityInspector();
        }

        // ============================================
        // UI Updates
        // ============================================
        function updateMatchList() {
            const list = document.getElementById('matchList');

            if (state.matches.length === 0) {
                list.innerHTML = `
                    <li class="empty-state">
                        <div class="icon">&#x1F3AE;</div>
                        <div>No matches yet</div>
                    </li>
                `;
                return;
            }

            list.innerHTML = state.matches.map(match => `
                <li class="${match.id === state.selectedMatchId ? 'selected' : ''}"
                    onclick="selectMatch(${match.id})">
                    <div class="item-title">Match #${match.id}</div>
                    <div class="item-badges">
                        ${match.enabledModuleNames.map(m => `<span class="badge module">${m}</span>`).join('')}
                    </div>
                    <div style="margin-top:8px;">
                        <button class="btn btn-danger" style="padding:4px 8px; font-size:10px;"
                                onclick="event.stopPropagation(); deleteMatch(${match.id})">Delete</button>
                    </div>
                </li>
            `).join('');
        }

        function updatePlayerList() {
            const list = document.getElementById('playerList');

            if (state.players.length === 0) {
                list.innerHTML = `
                    <li class="empty-state">
                        <div class="icon">&#x1F464;</div>
                        <div>No players yet</div>
                    </li>
                `;
                return;
            }

            list.innerHTML = state.players.map(player => `
                <li>
                    <div class="item-title">Player #${player.id}</div>
                    <div style="margin-top:8px;">
                        <button class="btn btn-danger" style="padding:4px 8px; font-size:10px;"
                                onclick="deletePlayer(${player.id})">Delete</button>
                    </div>
                </li>
            `).join('');
        }

        function updateModuleList() {
            const list = document.getElementById('moduleList');

            if (state.modules.length === 0) {
                list.innerHTML = `
                    <li class="empty-state">
                        <div class="icon">&#x1F4E6;</div>
                        <div>No modules loaded</div>
                    </li>
                `;
                return;
            }

            list.innerHTML = state.modules.map(module => `
                <li>
                    <div class="item-title">${module.name}</div>
                    <div class="item-meta">Flag: ${module.flagComponentName || 'None'}</div>
                    <div class="item-meta">Active in ${module.enabledMatches} match(es)</div>
                </li>
            `).join('');
        }

        function updateEntityInspector() {
            const inspector = document.getElementById('entityInspector');

            if (state.entities.length === 0) {
                inspector.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">&#x1F50D;</div>
                        <div>No entities in snapshot</div>
                    </div>
                `;
                return;
            }

            // todo for ai - please display each entity in a list, and allow me to click
            // to expand components.
            // right now each component is displayed as an entity, with the entity name
            // listed as the component name

            // for eg i see Entity #ENTITY_TYPE instead of "Entity (id=1) components: velocityX=..."
            inspector.innerHTML = state.entities.slice(0, 10).map(entity => `
                <div class="entity-inspector">
                    <h4>Entity #${entity.id}</h4>
                    <div class="component-list">
                        ${Object.entries(entity.components || {}).map(([name, values]) => `
                            <div class="component-item">
                                <span class="component-name">${name}</span>
                                <span class="component-value">${values.join(', ')}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('') + (state.entities.length > 10 ?
                `<div class="empty-state">... and ${state.entities.length - 10} more</div>` : '');
        }

        function selectMatch(matchId) {
            state.selectedMatchId = matchId;
            document.getElementById('selectedMatchName').textContent = `#${matchId}`;
            document.getElementById('matchIdInput').value = matchId;
            updateMatchList();
            connectSnapshotWs(matchId);
            fetchSnapshot(matchId);
            log(`Selected match ${matchId}`, 'info');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.panel-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.panel-section').forEach(section => section.classList.remove('active'));

            document.querySelector(`.panel-tab:nth-child(${tabName === 'actions' ? 1 : tabName === 'entities' ? 2 : 3})`).classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function log(message, type = 'info') {
            const panel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            panel.appendChild(entry);
            panel.scrollTop = panel.scrollHeight;

            // Keep only last 100 entries
            while (panel.children.length > 100) {
                panel.removeChild(panel.firstChild);
            }
        }

        // Command select toggle
        document.getElementById('commandSelect').addEventListener('change', function() {
            document.getElementById('spawnFields').style.display = this.value === 'spawn' ? 'block' : 'none';
            document.getElementById('moveFields').style.display = this.value === 'move' ? 'block' : 'none';
        });

        // ============================================
        // Global functions
        // ============================================
        let renderer;

        function resetView() {
            if (renderer) renderer.resetView();
        }

        // ============================================
        // Initialization
        // ============================================
        async function init() {
            log('Initializing panel...', 'info');

            // Initialize WebGL
            const canvas = document.getElementById('gameCanvas');
            renderer = new WebGLRenderer(canvas);
            renderer.render(0);

            // Connect WebSocket
            connectCommandWs();

            // Fetch initial data
            try {
                await Promise.all([
                    fetchMatches(),
                    fetchPlayers(),
                    fetchModules(),
                    fetchTick()
                ]);
                log('Initial data loaded', 'success');
            } catch (error) {
                log('Failed to load initial data', 'error');
            }

            // Auto-refresh
            setInterval(fetchTick, 5000);
        }

        // Start
        init();
    </script>
</body>
</html>
